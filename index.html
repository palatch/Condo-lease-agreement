<!DOCTYPE html>
<html lang="th">
<head>
    <!-- Meta tags for character set, viewport, and title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สัญญาเช่าสำหรับพิมพ์ (สองภาษา)</title>

    <!-- External Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <!-- Internal Styles -->
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        
        /* A4 Page styling for Desktop and Print */
        .page { 
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            padding-bottom: 30mm;
            margin: 10mm auto;
            border: 1px #D3D3D3 solid;
            border-radius: 5px;
            background: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            page-break-after: always; 
            position: relative;
        }
        .page:last-child { page-break-after: avoid; }
        
        .signature-line { margin-top: 2rem; border-bottom: 1px solid #333; }
        
        .signature-container-per-page {
            position: absolute;
            bottom: 40px;
            right: 60px;
            text-align: center;
            font-size: 0.75rem;
        }
        .signature-line-small {
            width: 180px;
            margin: 0 auto;
            border-bottom: 1px solid #333;
            margin-bottom: 0.25rem;
        }

        .clause { margin-bottom: 1rem; }
        .clause-title { font-weight: bold; }
        .english { color: #555; font-style: italic; margin-top: 0.25rem; }

        /* Mobile Responsive adjustments for viewing ONLY */
        @media (max-width: 900px) {
            .page-preview-on-mobile {
                width: 100%;
                min-height: auto;
                margin: 0;
                padding: 1rem;
                padding-bottom: 5rem; /* Space for signature */
                border: none;
                box-shadow: none;
                border-radius: 0;
            }
             .page-preview-on-mobile .signature-container-per-page {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 2rem;
                padding-top: 1rem;
                border-top: 1px dashed #ccc;
             }
        }
        
        /* Special style to force A4 rendering for html2canvas */
        .pdf-render-view .page {
             width: 210mm !important;
             min-height: 297mm !important;
             margin: 0 !important;
             border: none !important;
             box-shadow: none !important;
             border-radius: 0 !important;
        }


        /* Print-specific styles */
        @media print {
            html, body {
                width: 210mm;
                height: 297mm;        
            }
            .no-print { display: none; }
            .page {
                margin: 0;
                border: initial;
                border-radius: initial;
                width: initial;
                min-height: initial;
                box-shadow: initial;
                background: initial;
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8 no-print">

    <!-- =========== SETUP FORM =========== -->
    <div id="setup-form" class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-2xl font-bold">สร้างสัญญาเช่า (สองภาษา)</h1>
            <button id="clear-storage" class="text-xs text-red-500 hover:underline">ล้างข้อมูลที่บันทึกไว้</button>
        </div>
        <p class="text-center text-gray-600 mb-8">กรอกข้อมูลผู้ให้เช่า ผู้เช่า และสัญญา ข้อมูลจะถูกบันทึกอัตโนมัติ</p>
        
        <div class="space-y-8">
            <!-- Lessor Info Section -->
            <div>
                <h2 class="text-xl font-semibold border-b pb-2 mb-4">ข้อมูลผู้ให้เช่า (Lessor)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="lessor-name" placeholder="ชื่อ-สกุล (Full Name)" class="data-field p-2 border rounded">
                    <input type="number" id="lessor-age" placeholder="อายุ (Age)" class="data-field p-2 border rounded">
                    <input type="text" id="lessor-id" placeholder="เลขบัตรประชาชน (ID No.)" class="data-field p-2 border rounded">
                    <input type="text" id="lessor-phone" placeholder="เบอร์โทรศัพท์ (Phone No.)" class="data-field p-2 border rounded">
                    <textarea id="lessor-address" placeholder="ที่อยู่ (Address)" class="data-field p-2 border rounded md:col-span-2"></textarea>
                    <input type="text" id="lessor-bank-name" placeholder="ธนาคาร (Bank Name)" class="data-field p-2 border rounded">
                    <input type="text" id="lessor-account-name" placeholder="ชื่อบัญชี (Account Name)" class="data-field p-2 border rounded">
                    <input type="text" id="lessor-account-number" placeholder="เลขที่บัญชี (Account Number)" class="data-field p-2 border rounded md:col-span-2">
                </div>
            </div>

            <!-- Renter Info Section -->
            <div>
                <h2 class="text-xl font-semibold border-b pb-2 mb-4">ข้อมูลผู้เช่า (Renter)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="renter-name" placeholder="ชื่อ-สกุล (Full Name)" class="data-field p-2 border rounded">
                    <input type="number" id="renter-age" placeholder="อายุ (Age)" class="data-field p-2 border rounded">
                    <input type="text" id="renter-id" placeholder="เลขบัตรประชาชน/พาสปอร์ต (ID/Passport No.)" class="data-field p-2 border rounded">
                    <input type="text" id="renter-phone" placeholder="เบอร์โทรศัพท์ (Phone Number)" class="data-field p-2 border rounded">
                    <textarea id="renter-address" placeholder="ที่อยู่ (Address)" class="data-field p-2 border rounded md:col-span-2"></textarea>
                </div>
            </div>

            <!-- Contract Info Section -->
            <div>
                <h2 class="text-xl font-semibold border-b pb-2 mb-4">ข้อมูลสัญญา (Contract Details)</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-6">
                    <div>
                        <label for="room-select" class="block text-sm font-medium text-gray-700">ห้องเลขที่</label>
                        <select id="room-select" class="data-field mt-1 block w-full p-2 border rounded">
                            <option value="" disabled selected>กรุณาเลือกห้อง</option>
                            <option value="C2-503 18/108">C2-503 18/108</option>
                            <option value="C2-504 18/109">C2-504 18/109</option>
                            <option value="C2-507 18/112">C2-507 18/112</option>
                            <option value="C7-326 23/77">C7-326 23/77</option>
                            <option value="F1-0203 35/25">F1-0203 35/25</option>
                        </select>
                    </div>
                     <div>
                        <label for="rent-amount" class="block text-sm font-medium text-gray-700">ค่าเช่าต่อเดือน (Monthly Rent)</label>
                        <input type="number" id="rent-amount" placeholder="5000" class="data-field mt-1 p-2 border rounded w-full">
                    </div>
                     <input type="text" id="contract-location" class="data-field p-2 border rounded" value="ลุมพินีทาวชิปรังสิตคลอง 1" hidden>
                    <div>
                        <label for="asset-code" class="block text-sm font-medium text-gray-700">รหัสทรัพย์สิน (Asset Code)</label>
                        <input type="text" id="asset-code" placeholder="รหัสทรัพย์สิน" class="data-field mt-1 p-2 border rounded w-full bg-gray-100" readonly>
                    </div>
                     <div>
                        <label for="asset-no" class="block text-sm font-medium text-gray-700">ทรัพย์เลขที่ (Property No.)</label>
                        <input type="text" id="asset-no" placeholder="ทรัพย์เลขที่" class="data-field mt-1 p-2 border rounded w-full bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="contract-date" class="block text-sm font-medium text-gray-700">วันที่ทำสัญญา (Contract Date)</label>
                        <input type="date" id="contract-date" class="data-field mt-1 p-2 border rounded w-full">
                    </div>
                    <div>
                        <label for="contract-start-date" class="block text-sm font-medium text-gray-700">วันที่เริ่มสัญญา (Start Date)</label>
                        <input type="date" id="contract-start-date" class="data-field mt-1 p-2 border rounded w-full">
                    </div>
                    <div>
                        <label for="contract-end-date" class="block text-sm font-medium text-gray-700">วันที่สิ้นสุดสัญญา (End Date)</label>
                        <input type="date" id="contract-end-date" class="data-field mt-1 p-2 border rounded w-full">
                    </div>
                </div>
            </div>

            <!-- Additional Assets Section -->
            <div>
                <h2 class="text-xl font-semibold border-b pb-2 mb-4">ทรัพย์สินเพิ่มเติม (Additional Assets)</h2>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <input id="has-digital-lock" type="checkbox" class="data-field h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="has-digital-lock" class="ml-2 block text-sm text-gray-900">Digital Door Lock</label>
                    </div>
                    <div class="flex items-center">
                        <input id="has-washing-machine" type="checkbox" class="data-field h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="has-washing-machine" class="ml-2 block text-sm text-gray-900">เครื่องซักผ้า (Washing Machine)</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center mt-10">
            <button id="preview-contract" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors">ดูตัวอย่างและสร้าง PDF</button>
        </div>

        <!-- Visitor Counter -->
        <div class="text-center mt-6 text-xs text-gray-400">
            จำนวนผู้เข้าชม: <span id="visitor-counter">0</span>
        </div>
    </div>

    <!-- =========== CONTRACT CONTENT (for PDF generation) =========== -->
    <div id="contract-container" class="bg-gray-100" style="display: none;">
        <div id="contract-content" class="max-w-4xl mx-auto">
            <!-- All contract pages will be dynamically populated here by JavaScript -->
        </div>
    </div>

    <!-- =========== ACTION BUTTONS for Preview =========== -->
    <div id="action-buttons" class="max-w-4xl mx-auto mt-6 text-center space-x-4 no-print" style="display: none;">
        <button id="edit-info" class="bg-yellow-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-yellow-600 transition-colors">กลับไปแก้ไข</button>
        <button id="download-pdf" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors">ดาวน์โหลด PDF</button>
        <p id="loading-message" class="text-gray-600 mt-2" style="display: none;">กำลังสร้างไฟล์ PDF...</p>
    </div>

    <!-- JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Visitor Counter ---
            const updateVisitorCount = () => {
                let count = localStorage.getItem('rentalAgreementVisitorCount');
                count = count ? parseInt(count) + 1 : 1;
                localStorage.setItem('rentalAgreementVisitorCount', count);
                const counterElement = document.getElementById('visitor-counter');
                if(counterElement) {
                    counterElement.textContent = count;
                }
            };
            updateVisitorCount();

            const formFields = document.querySelectorAll('.data-field');
            const roomSelect = document.getElementById('room-select');
            
            // --- Local Storage Functions ---
            const saveFormData = () => {
                const data = {};
                formFields.forEach(field => {
                    if (field.type === 'checkbox') {
                        data[field.id] = field.checked;
                    } else {
                        data[field.id] = field.value;
                    }
                });
                localStorage.setItem('rentalAgreementData', JSON.stringify(data));
            };

            const loadFormData = () => {
                const savedData = localStorage.getItem('rentalAgreementData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    formFields.forEach(field => {
                        if (data[field.id] !== undefined) {
                             if (field.type === 'checkbox') {
                                field.checked = data[field.id];
                            } else {
                                field.value = data[field.id];
                            }
                        }
                    });
                    if (roomSelect.value) {
                         roomSelect.dispatchEvent(new Event('change'));
                    }
                }
            };
            
            formFields.forEach(field => {
                field.addEventListener('change', saveFormData);
            });
            
            document.getElementById('clear-storage').addEventListener('click', () => {
                if(confirm('คุณต้องการล้างข้อมูลที่บันทึกไว้ทั้งหมดใช่หรือไม่?')) {
                    localStorage.removeItem('rentalAgreementData');
                    location.reload();
                }
            });

            roomSelect.addEventListener('change', (e) => {
                const selection = e.target.value;
                if (!selection) return;

                const [code, number] = selection.split(' ');
                document.getElementById('asset-code').value = code || '';
                document.getElementById('asset-no').value = number || '';
            });
            
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Bangkok' };
                return date.toLocaleDateString('th-TH', options);
            };

            const formatCurrency = (num) => {
                const number = parseFloat(num);
                if (isNaN(number)) return '0.00';
                return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            document.getElementById('preview-contract').addEventListener('click', () => {
                const data = {};
                formFields.forEach(field => {
                     if (field.type === 'checkbox') {
                        data[field.id] = field.checked;
                    } else {
                        data[field.id] = field.value;
                    }
                });
                const fullRoomDetails = `ห้องเลขที่ ${data['room-select']} โครงการ ${data['contract-location']}`;
                const rentAmount = parseFloat(data['rent-amount'] || 0);
                const securityDeposit = rentAmount * 2;
                const totalInitialPayment = rentAmount * 3;

                const contractContentEl = document.getElementById('contract-content');
                
                // --- Generate Contract HTML ---
                const contractHTML = `
                    <!-- Page 1 -->
                    <div class="page">
                        <div class="text-center mb-6"><h1 class="text-xl font-bold">สัญญาเช่า / Residential Lease Agreement</h1></div>
                        <p class="text-sm">เขียนที่/Write at: ${data['contract-location']}</p>
                        <p class="text-sm">วันที่/Date: ${formatDate(data['contract-date'])}</p>
                        <div class="mt-4 text-sm"><p>สัญญานี้ทำขึ้นระหว่าง</p><p class="english">This agreement is made between</p></div>
                        <div class="my-4 p-4 border rounded text-sm"><p><strong class="font-bold">ผู้ให้เช่า (Lessor):</strong> ${data['lessor-name']} อายุ/Age ${data['lessor-age']} ปี</p><p>เลขบัตร/ID No.: ${data['lessor-id']} โทร/Tel: ${data['lessor-phone']}</p><p>ที่อยู่/Address: ${data['lessor-address']}</p></div>
                        <div class="my-4 p-4 border rounded text-sm"><p><strong class="font-bold">ผู้เช่า (Renter):</strong> ${data['renter-name']} อายุ/Age ${data['renter-age']} ปี</p><p>เลขบัตร/ID No.: ${data['renter-id']} โทร/Tel: ${data['renter-phone']}</p><p>ที่อยู่/Address: ${data['renter-address']}</p></div>
                        <div class="space-y-4 text-sm">
                            <div class="clause"><p class="clause-title">ข้อ 1: ทรัพย์สินที่เช่า / Article 1: Rented Property</p><p>ผู้ให้เช่าตกลงให้เช่าและผู้เช่าตกลงเช่า ${fullRoomDetails} ต.ประชาธิปัตย์ อ.ธัญบุรี จ.ปทุมธานี 12130 เพื่อวัตถุประสงค์ในการอยู่อาศัยสำหรับผู้พักอาศัยไม่เกิน 2 คน</p><p class="english">The "Lessor" agrees to rent and "Renter" agrees to rent the property at ${fullRoomDetails}, Prachathipat, Thanyaburi, Pathum Thani 12130 for the sole purpose of residence with not exceeding 2 people.</p></div>
                            <div class="clause"><p class="clause-title">ข้อ 2: ระยะเวลาการเช่า / Article 2: Term of Agreement</p><p>สัญญามีระยะเวลา 12 เดือน เริ่มตั้งแต่วันที่ ${formatDate(data['contract-start-date'])} และสิ้นสุดในวันที่ ${formatDate(data['contract-end-date'])}</p><p class="english">This agreement has a period of 12 months, commencing on ${formatDate(data['contract-start-date'])} and ending on ${formatDate(data['contract-end-date'])}.</p></div>
                            <div class="clause"><p class="clause-title">ข้อ 3: ค่าเช่าและการชำระเงิน / Article 3: Rent and Payment</p><p>ค่าเช่าตกลงกันในอัตราเดือนละ ${formatCurrency(rentAmount)} บาท ผู้เช่าจะต้องชำระค่าเช่าล่วงหน้าภายในวันที่ 5 ของแต่ละเดือน โดยโอนเงินเข้าบัญชีธนาคาร ${data['lessor-bank-name']} ชื่อบัญชี ${data['lessor-account-name']} เลขที่ ${data['lessor-account-number']} หากผู้เช่าชำระค่าเช่าล่าช้ากว่ากำหนด ผู้เช่าตกลงจ่ายค่าปรับในอัตรา 200 บาทต่อวัน หากผู้เช่าไม่ชำระค่าเช่าและค่าปรับภายใน 15 วันนับจากวันครบกำหนด ผู้ให้เช่ามีสิทธิ์บอกเลิกสัญญา ยึดเงินประกันทั้งหมด และเข้าครอบครองทรัพย์สินได้ทันที</p><p class="english">The rent is agreed at ${formatCurrency(rentAmount)} Baht per month. The "Renter" shall pay the rent in advance by the 5th of each month by transferring money into ${data['lessor-bank-name']} account, Name: ${data['lessor-account-name']}, A/C No: ${data['lessor-account-number']}. In the event that the "Renter" pays the rent later than the due date, a late fee of 200.00 Baht per day will be applied. If the "Renter" does not pay the rent and fines in full within 15 days, the "Lessor" has the right to terminate the contract, confiscate all rental deposits, and repossess the property immediately.</p></div>
                        </div>
                        <div class="signature-container-per-page"><div class="signature-line-small"></div><p>( ${data['renter-name']} )</p><p>ผู้เช่า / Renter</p></div>
                    </div>
                    <!-- Page 2 - Payment Schedule -->
                    <div class="page text-sm">
                        <h2 class="text-lg font-bold text-center mb-4">ตารางกำหนดการชำระเงิน / Payment Schedule</h2>
                        <table class="w-full border-collapse border border-slate-400">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="border border-slate-300 p-2">งวดชำระ<br><span class="font-normal text-xs">Payment Period</span></th>
                                    <th class="border border-slate-300 p-2">รอบการชำระ<br><span class="font-normal text-xs">Payment Cycle</span></th>
                                    <th class="border border-slate-300 p-2">ค่าเช่า<br><span class="font-normal text-xs">Rent Amount</span></th>
                                    <th class="border border-slate-300 p-2">กำหนดชำระ<br><span class="font-normal text-xs">Payment Due</span></th>
                                    <th class="border border-slate-300 p-2">หมายเหตุ<br><span class="font-normal text-xs">Note</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${[...Array(12)].map((_, i) => {
                                    const dueDate = new Date(data['contract-start-date'] || '2025-09-12');
                                    dueDate.setMonth(dueDate.getMonth() + i);
                                    const dueDateStr = `15 ${dueDate.toLocaleString('th-TH', { month: 'long', year: 'numeric' })}`;
                                    return `
                                    <tr>
                                        <td class="border border-slate-300 p-2 text-center">${i + 1}</td>
                                        <td class="border border-slate-300 p-2">ค่าเช่าเดือนที่ ${i + 1} / ${i + 1}${['st','nd','rd'][i] || 'th'} month rent</td>
                                        <td class="border border-slate-300 p-2 text-right">${formatCurrency(rentAmount)}</td>
                                        <td class="border border-slate-300 p-2 text-center">${dueDateStr}</td>
                                        <td class="border border-slate-300 p-2">${i === 0 ? 'วันที่ทำสัญญา/Contract date' : ''}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                        <div class="signature-container-per-page"><div class="signature-line-small"></div><p>( ${data['renter-name']} )</p><p>ผู้เช่า / Renter</p></div>
                    </div>
                    <!-- Other pages... -->
                `;
                
                contractContentEl.innerHTML = contractHTML;

                // Add mobile preview class to all generated pages
                contractContentEl.querySelectorAll('.page').forEach(page => page.classList.add('page-preview-on-mobile'));

                document.getElementById('setup-form').style.display = 'none';
                document.getElementById('contract-container').style.display = 'block';
                document.getElementById('action-buttons').style.display = 'block';
            });

            document.getElementById('edit-info').addEventListener('click', () => {
                document.getElementById('setup-form').style.display = 'block';
                document.getElementById('contract-container').style.display = 'none';
                document.getElementById('action-buttons').style.display = 'none';
            });

            document.getElementById('download-pdf').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById('contract-content');
                const loadingMessage = document.getElementById('loading-message');
                const actionButtons = document.getElementById('action-buttons');
                const contractContainer = document.getElementById('contract-container');
                
                actionButtons.style.display = 'none';
                loadingMessage.style.display = 'block';

                // Add class to force A4 rendering styles
                contractContainer.classList.add('pdf-render-view');

                let promiseChain = Promise.resolve();
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pages = content.querySelectorAll('.page');

                pages.forEach((page, index) => {
                    promiseChain = promiseChain.then(() => 
                        html2canvas(page, { 
                            scale: 2, 
                            useCORS: true,
                            // Ensure it renders at full A4 width
                            windowWidth: page.scrollWidth,
                            windowHeight: page.scrollHeight
                        }).then(canvas => {
                            if (index > 0) {
                                pdf.addPage();
                            }
                            const imgData = canvas.toDataURL('image/png', 0.95);
                            pdf.addImage(imgData, 'PNG', 0, 0, 210, 297, undefined, 'FAST');
                        })
                    );
                });

                promiseChain.finally(() => {
                    pdf.save('สัญญาเช่าสองภาษา.pdf');
                    actionButtons.style.display = 'block';
                    loadingMessage.style.display = 'none';
                    // IMPORTANT: remove the class to restore normal view
                    contractContainer.classList.remove('pdf-render-view');
                });
            });

            loadFormData();
        });
    </script>
</body>
</html>

